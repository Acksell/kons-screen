<head>
<meta charset="UTF-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<style>
h1 {font-size:40px;text-align: center;}
p {font-size:15px;text-align: center;}
</style>
</head>

<h1>Socket app</h1>
<p>Fetches time from server every 10 seconds and embeds some facebook posts.</p>
<h1 id="time"></h1>
<p id="post-1"></p>

<!-- Socket logic -->

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">

function updateInstagramPosts(instagram){
    // loop over elements with same class and change with jquery.
    $('.instagram-media-rendered').each(function(i, obj) {
        $(obj).attr("src", "https://www.instagram.com/p/" + instagram[i].code + "/embed/captioned/?cr=1&v=7&wp=658#%7B%22ci%22%3A0%2C%22os%22%3A373.82500000000005%7D");
    });
};

function updateFacebookPosts(facebook){
    // loop over elements with same class and change with jquery.
    $('.fbpost').each(function(i, obj) {
        $(obj).text(facebook[i].message);
        $(obj).id = facebook[i].id
    });
};

function updateCalendarEvents(calendar){
    // loop and change with jquery.
};

var socket = io.connect('http://' + document.domain + ':' + location.port);
socket.on('connect', function() {
    socket.emit("update")
    console.log("Connected.")
});

socket.on('server response', function(msg) {
    console.log("Server responded!");
    console.log("Time is: " + msg.time);
    $('#time').text("Time: " + msg.time); // modify html document
    if (msg.instagram){
        updateInstagramPosts(msg.instagram);
    }
    if (msg.facebook){
        updateFacebookPosts(msg.facebook);
    }
    if (msg.calendar){
        updateCalendarEvents(msg.calendar);
    }
});

setInterval(getData, 10000) // fetch new data every 10 seconds.

function getData(){
    socket.emit("update");  // grab another update from database.
    
    /* This could be replaced with a jQuery AJAX call to the main
       server. It would then call all the update functions with
       the retrieved JSON data.
    */
    
}

</script>

<!-- Instagram embedding -->
<script async defer src="//platform.instagram.com/en_US/embeds.js"></script>

<!-- Social media feed -->
{% block facebook %}
{% endblock %}

{% block instagram %}
{% endblock %}

